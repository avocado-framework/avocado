#!/bin/bash
ERR=()
run_rc() {
    CHECK=$1
    shift
    echo -e "\n\e[32mRunning '$1'\e[0m"
    eval $1
    if [ $? != 0 ]; then
        echo -e "\e[31m$CHECK FAILED\e[0m"
        ERR+=("$CHECK")
        [ ! "$SELF_CHECK_CONTINUOUS" ] && exit 1
    else
        echo -e "\e[32m$CHECK PASSED\e[0m\n"
    fi
}
run_rc lint 'inspekt --exclude=.git lint'
run_rc indent 'inspekt --exclude=.git indent'
run_rc style 'inspekt --exclude=.git style'
run_rc boundatires 'selftests/modules_boundaries'
if [ -z "$AVOCADO_SELF_CHECK" ]; then
    run_rc selftests selftests/run
else
    run_rc selftests 'scripts/avocado run `./contrib/scripts/avocado-find-unittests selftests/{unit,functional,doc}/*.py | xargs` --external-runner="/usr/bin/env python -m unittest"'
fi

if [ "$ERR" ]; then
    echo -e "\e[31m"
    echo "Checks:"
    for CHECK in "${ERR[@]}"; do
        echo -e " * $CHECK FAILED"
    done
    echo -ne "\e[0m"
else
    echo -e "\e[32mAll checks PASSED\e[0m"
fi
if [ "$ERR" ]; then
    exit 1
fi
exit 0
